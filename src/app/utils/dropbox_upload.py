import dropbox
from uuid import uuid4
from fastapi import UploadFile
from datetime import datetime

ACCESS_TOKEN = "sl.u.AFxTqHy4Kioh33eZLo7COYbaf_aT824QT-UslWCI6fZCYWG6qNiWVsTItF9Izxo_8DakHhyL7r355bVeR0_yKl2oOuSq2heJGSAVL2UrXIUEynYVLMrU0z8WGKr_qqP11myjIQsEr1O_Nv3o35WLsG00k0nRJjQJfVMtD6L2mavTCdOiAuJqKranQyn7BFUfXHxiKUnuQDdIIuLmogncp_TUx-B5bR8I2sk8rL-VmB9G1HVCH9OJ3EKnk4ey2nXBNI-6AQBkvCbgQNsGI7_SLfY6-Mtpwcnsm2paZfJ457naTklI9AL9CPNHKQWQ4qHBs8yvOSg8lkr2v_GE5G3PFKLaDzyn-FrXl7VL5Nig1PlS5ZgEZd8__wwpJbCjagaL0SRGlM5dFMiWPR5T_7DsB0sjL-R_W9INxRo4NYFLE1iMYiAviWwuQNh6Uh_ovdtup_PHHFxSxDq-utnihdfN1r2nKXC5NqutnOV5kXU-hHtlOVZJqXS81xEdrOw3EBmGj2AwC7-ZTauVPe8c7X05vo3rs5Cx-phvIKQSvnBkL8ACcAapqtXFpfR_1xV4urx9FmW7Fb4GS-gPKPRXEjVgz-6x9MUUFtm8jnsG828cwYrnrFtZTPoc0eOOGB_UMsyR8ewxjDRl9TrJtojcY6IBdD-0cpJxDN_LGPhyyEnuMRb_HjE6WHbH_qL7qtlq4f-bVNPnCjcRuGPEj2hntCM6DXewSlsIyO1eYItGt-IIV4RXoP5osSl3ucZcBSXoNYKSVZRTnQqv_5UkDMXhOJd0M28kHf70sSaKaZqbSemQ8K6sTKB09tMYO1BcQ1UI25vMECl6ba28JIhCXWJ_TpiH3Z-oJMMyGvsxYAAoOdeKTTi6fnUI5eMQLjI27XBKYYPL7AEoirNKCeMe6AdZ0EifstuiRxsy2VXZQB33UKGageEmVVYgg5Z4k0uXOpi1x3m0Vk72YCTrJXk5W5dm3fF6wxIkBjHPC1GkWG0gZQEgKwAnFxBf1o2kR7LDvMqAiCGpSn_FXpLHamIeHUjeJuA26om9LxOYCMsTBF9mrglm5Z6j17FQbd0L5CLF0JThaAO3VAobD0hZR6Cu223NyTVUuSzhGFihn98e6K9x78VFKVgZkxZUSrsM66WMjoeCqPcmVU3URVm3Ao54-3HIaFQLSvtNoH9D6yjwmUMKI59vdxJlwu3XZgqeBRr3lBigo_pWf649EzIokdGaIGd7O2yQVegXH9swDhFYog-woEcZwj5Qsjo1HfdEW_F5ZITlUTT2og3yP-qCkw2H9EbRFrwyTYvfJrhY8gC6qm1MmcMYzovnCYYHqQQYzAkfOcoDVi9VkaL1XU2gcakJLRc0fHO4Gxk6eu4YBlttIClhT4IdMs36Eb5jQbO4P5bcRmS8ZH7sYmmT0uWeWvm3Ya2ZeX_gjMYgKdjNYMJSkHqFjk9Uuu_hLq9yKAbnQz3KqOXnoSBGN1Y"

def upload_to_dropbox(userid:str,file: UploadFile, tag: str = "untagged") -> str:
    dbx = dropbox.Dropbox(ACCESS_TOKEN)
    timestamp = datetime.now().strftime("%Y%m%d%H%M%S")
    filename = f"{userid}_{tag}_{timestamp}.pdf"
    dropbox_path = f"/{filename}"

    # Read file contents and upload
    file_bytes = file.file.read()
    dbx.files_upload(file_bytes, dropbox_path, mode=dropbox.files.WriteMode("overwrite"))

    # Create shared link
    shared_link_metadata = dbx.sharing_create_shared_link_with_settings(dropbox_path)
    url = shared_link_metadata.url.replace("?dl=0", "?dl=1")
    return url
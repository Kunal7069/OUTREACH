import dropbox
from uuid import uuid4
from fastapi import UploadFile

ACCESS_TOKEN = "sl.u.AFxitFQ-GugGiGAqDRPWAkLrD4yuYLmwRyT4nI9SqEzxheUc1nK6IO3VUxEZYjeAFuSQKJWzgt-AQ-zgk1PMYQPI-ovW3nES74J-EfAbUmzAuG2Jw7gsTUSO97qTFpicU54SJ3Praxb891jTRSXIqgG5_v0w-ODD0MoC35iP0U-xNZcde8gLavE6epUDdDggnpbw5CHw1FEaSP8PEpZ9yNrsv_iNj52ZV_gPe0vbBojsIWbeor7saUgD-YmgOlZNnSNGDn7K5bQqRO_T_qBuqnDWbc7zZJ1j2KkTgUCxo84aV3IfzDVJgCS_fdDFvxBFo6OFXO_UiifAlo3iiQORPTIUruUTi4ntm2OYYL90B0pc_98wpCRIGK5yxaCArXwIZ8tRlh7kdE9RFfOi1KaxOl6oaI52-A3lyGs_Yt2H0B72pLFHS9ehx8VxnOMzznXMamC_Jpb_dsj28Fyv527LXn95O5fj5AS7YL5-iiFzAOvPsIETESLzhcH5PNlZxYIJYQayFe00FATXuKl-Z9Hjbzoq2y0lHOoPhJUDbcZH_ux-lyiSRmGEcBfOFhzMiZaZay1BwgrXPMrK8LnQr7-DUBP_u8VHllfh49kXRWhrEwCtR_uNilZwSubC1JwE6MrVe3cYQbGk3_LHsbR-ZKohN8NpWTlklm4lKdEacycHycOYIFGBy_SOr7W92jgF2qeSYvqzo2KykVAiIDRCK4OYat8o3B9O7tT1IBozhxNv9TNznu2573ASfqmadkXV6UpVVkAu-z0hfqgl-oUZjWAMZrOJcz1omEnFEROL7DY6Z5Gmamuimw1L0QG3s6j6PWiZ5aU79U1sCoTb5wx6euQLyLbCDaaQk29xLaofn5wneQiV8u9rMDPx9FQM_JrGOGN_oivt6PwjIsd1vwfV_D2YDb5qTZSZ0u4yWaFBn-MYwxl_CuUc-WC0abMMTmN19GXZUIeWX4OU-nwbo1AXJyHcvcDVHkDqQyR0MTJrnPdNXS1HtRyfMOEUTltLVxzk0Thdksbx0nBzBUOoAIAfaQsrGrx0bk6SVnYHePhwuSJ4Mo7_Y-PUP_M_gIQ0c36eYrDxKIM5hdmocJQHEzHrHD5K1r5t-XkBhcauarmAbWOB9rktgs-vhLgh1wf-MpommnAwB7Iz6Lm7ACaRgiy3UJZz2pI-vG29ahG2WC8jKGF1LUnqWT4feAH2v1WHZ5YHUBsdxklHepNr6jFjW9yoPTZVPk6kmEx870rU9STIhauXcIgm4QVn1tIxshrqsgwZOx3usIzdXz0PzmhNZjaGw8Bf6a5l1k9BBo-bbnRMk2G5lI-iDo901Zk3byMrDPPlg5DOfyuM782kORZ7SEn58kPRM8jQsvGFqT6DCTd8cEle1aJIl7PQWXGiq3m2-epJksrANbGOtLlrNEiY5yHOr4LVvx_DYEyp0XTHQyUe8zmp2PLX8aYuDfmADfMqZHltDmDX7Jo"

def upload_to_dropbox(userid:str,file: UploadFile, tag: str = "untagged") -> str:
    dbx = dropbox.Dropbox(ACCESS_TOKEN)

    filename = f"{userid}_{tag}.pdf"
    dropbox_path = f"/{filename}"

    # Read file contents and upload
    file_bytes = file.file.read()
    dbx.files_upload(file_bytes, dropbox_path, mode=dropbox.files.WriteMode("overwrite"))

    # Create shared link
    shared_link_metadata = dbx.sharing_create_shared_link_with_settings(dropbox_path)
    url = shared_link_metadata.url.replace("?dl=0", "?dl=1")
    return url